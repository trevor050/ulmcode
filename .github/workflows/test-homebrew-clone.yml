name: test-homebrew-clone

on:
  push:
    branches:
      - dev
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  clone:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v3

      - name: Setup git committer
        id: committer
        uses: ./.github/actions/setup-git-committer
        with:
          opencode-app-id: ${{ vars.OPENCODE_APP_ID }}
          opencode-app-secret: ${{ secrets.OPENCODE_APP_SECRET }}

      - name: Verify token present
        run: |
          if [ -z "${GITHUB_TOKEN}" ]; then
            echo "GITHUB_TOKEN is missing"
            exit 1
          fi
          echo "GITHUB_TOKEN is present"
        env:
          GITHUB_TOKEN: ${{ steps.committer.outputs.token }}

      - name: Clone homebrew tap
        run: |
          echo "Testing old URL pattern"
          old="https://${GITHUB_TOKEN}@github.com/sst/homebrew-tap.git"
          git clone "${old}" ./dist/homebrew-tap-old
          rm -rf ./dist/homebrew-tap-old

          echo "Testing new URL pattern"
          tap="https://x-access-token:${GITHUB_TOKEN}@github.com/anomalyco/homebrew-tap.git"
          git clone "${tap}" ./dist/homebrew-tap
          cd ./dist/homebrew-tap
          git status -sb
        env:
          GITHUB_TOKEN: ${{ steps.committer.outputs.token }}
